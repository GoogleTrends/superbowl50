<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Language" content="en" />
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="js/jquery.js"></script>
     <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <title>Superbowl</title>
</head>
<style>
body {
    font-family: 'Roboto', sans-serif;
}


.land {
    fill: #e6e6e6;
    opacity: .3;
    stroke: black;
    stroke-width: 1px;
}

.county-boundary {
    fill: none;
    stroke: #fff;
    stroke-width: .5px;
}

.arcs path {
    /*stroke: url(#line-gradient);*/
    stroke: orange;
    pointer-events: none;
    opacity: .6;
    fill: none;
}
</style>

<body>
    <div id="graphic"></div>
    <script type="text/javascript" src="js/d3.min.js"></script>
    <script type="text/javascript" src="js/topojson.v1.min.js"></script>
    <script src="cities.js"></script>
    <script>
    var width = 960,
        height = 500;

    var projection = d3.geo.albersUsa()
        .scale(1000)
        .translate([width / 2, height / 2]);

    var path = d3.geo.path()
        .projection(projection);

    var svg = d3.select("#graphic").append("svg")
        .attr("width", width)
        .attr("height", height)
        .call(responsivefy);

    var color = d3.interpolateLab("#008000", "#c83a22");

    d3.json("us.json", function(error, us) {
        if (error) throw error;

        svg.insert("path", ".graticule")
            .datum(topojson.feature(us, us.objects.land))
            .attr("class", "land")
            .attr("d", path);


        // draw the curves between each city and San Francisco

        var arcs = svg.append("g")
            .attr("class", "arcs");

        var line = arcs.selectAll("path")
            .data(arcdata)
            .enter()
            .append("path")
            .attr("id", function(d, i) {
                return "curve" + i;
            })
            .attr("d", function(d) {
                return lngLatToArc(d, 'sourceLocation', 'targetLocation', 15);
            })
            .style("stroke-width", function(d, i) {
                return arcdata[i].index * .5;
            });

        // add the name of each city

        svg.selectAll("text")
            .data(arcdata)
            .enter()
            .append("text")
            .style("fill", "black")
            .style("font-size", 12)
            .attr("text-anchor", "middle")
            .text(function(d, i) {
                return arcdata[i].city;
            })
            .attr("transform", function(d, i) {
                return "translate(" + projection([arcdata[i].sourceLocation[0], (arcdata[i].sourceLocation[1] + .8)]) + ")";
            });



        // add a point on where the city is 

        svg.selectAll(".point")
            .data(arcdata)
            .enter()
            .append("circle")
            .attr("r", function(d, i) {
                return arcdata[i].index * .6;
            })
            .style("fill", "grey")
            .attr("transform", function(d, i) {
                return "translate(" + projection([arcdata[i].sourceLocation[0], arcdata[i].sourceLocation[1]]) + ")";
            });


        


        // add the moving points 

        // function createVariables() {
        //     var circle = [];
        //     for (var i = 0; i <= 11; i++) {
        //         circle[i] = svg.selectAll(".point")
        //             .data(arcdata[i])
        //             .enter()
        //             .append("circle")
        //             .attr("r", 5)
        //             .style("fill", "black")
        //             .style("opacity", .8)
        //             // .attr("id",function(d,i){
        //             //     return "point" + i ;
        //             // })
        //             .attr("transform", function(d) {
        //                 return "translate(" + projection([d.sourceLocation[0], d.sourceLocation[1]]) + ")";
        //             });
        //     }
        // }

        // MOVE THE DOTS!!!!    

        var circle10 = svg.selectAll(".point")
            .data(arcdata)
            .enter()
            .append("circle")
            .attr("r", 3)
            .style("fill", "grey")
            .style("opacity",.8)
            .attr("transform", function(d) {
                return "translate(" + projection([arcdata[10].sourceLocation[0], arcdata[10].sourceLocation[1]]) + ")";
            });

        var line10 = svg.append("path")
            .style("stroke", "none")
            .style("fill", "none")
            .attr("d", function(d) {
                return lngLatToArc(arcdata[10], 'sourceLocation', 'targetLocation', 1);
            });


        var circle9 = svg.selectAll(".point")
            .data(arcdata)
            .enter()
            .append("circle")
            .attr("r", 3)
            .style("fill", "grey")
            .style("opacity",.8)
            .attr("transform", function(d) {
                return "translate(" + projection([arcdata[9].sourceLocation[0], arcdata[9].sourceLocation[1]]) + ")";
            });

        var line9 = svg.append("path")
            .style("stroke", "none")
            .style("fill", "none")
            .attr("d", function(d) {
                return lngLatToArc(arcdata[9], 'sourceLocation', 'targetLocation', 1);
            });

        var circle8 = svg.selectAll(".point")
            .data(arcdata)
            .enter()
            .append("circle")
            .attr("r", 3)
            .style("fill", "grey")
            .style("opacity",.8)
            .attr("transform", function(d) {
                return "translate(" + projection([arcdata[8].sourceLocation[0], arcdata[8].sourceLocation[1]]) + ")";
            });

        var line8 = svg.append("path")
            .style("stroke", "none")
            .style("fill", "none")
            .attr("d", function(d) {
                return lngLatToArc(arcdata[8], 'sourceLocation', 'targetLocation', 1);
            });

         var circle7 = svg.selectAll(".point")
            .data(arcdata)
            .enter()
            .append("circle")
            .attr("r", 3)
            .style("fill", "grey")
            .style("opacity",.8)
            .attr("transform", function(d) {
                return "translate(" + projection([arcdata[7].sourceLocation[0], arcdata[7].sourceLocation[1]]) + ")";
            });

        var line7 = svg.append("path")
            .style("stroke", "none")
            .style("fill", "none")
            .attr("d", function(d) {
                return lngLatToArc(arcdata[7], 'sourceLocation', 'targetLocation', 1);
            });

        var circle6 = svg.selectAll(".point")
            .data(arcdata)
            .enter()
            .append("circle")
            .attr("r", 3)
            .style("fill", "grey")
            .style("opacity",.8)
            .attr("transform", function(d) {
                return "translate(" + projection([arcdata[6].sourceLocation[0], arcdata[6].sourceLocation[1]]) + ")";
            });

        var line6 = svg.append("path")
            .style("stroke", "none")
            .style("fill", "none")
            .attr("d", function(d) {
                return lngLatToArc(arcdata[6], 'sourceLocation', 'targetLocation', 1);
            });

        var circle5 = svg.selectAll(".point")
            .data(arcdata)
            .enter()
            .append("circle")
            .attr("r", 3)
            .style("fill", "grey")
            .style("opacity",.8)
            .attr("transform", function(d) {
                return "translate(" + projection([arcdata[5].sourceLocation[0], arcdata[5].sourceLocation[1]]) + ")";
            });

        var line5 = svg.append("path")
            .style("stroke", "none")
            .style("fill", "none")
            .attr("d", function(d) {
                return lngLatToArc(arcdata[5], 'sourceLocation', 'targetLocation', 1);
            });



        transition();


        function transition() {
            circle10.transition()
                .delay(function(d,i){
                    return  i * 300;
                })
                .duration(5000)
                .attrTween("transform", translateAlong(line10.node()))
                .each("end", transition);

            circle9.transition()
                .delay(function(d,i){
                    return  i * 200;
                })
                .duration(5000)
                .attrTween("transform", translateAlong(line9.node()))
                .each("end", transition);

            circle8.transition()
                .delay(function(d,i){
                    return  i * 250;
                })
                .duration(5000)
                .attrTween("transform", translateAlong(line8.node()))
                .each("end", transition);

            circle7.transition()
                .delay(function(d,i){
                    return  i * 350;
                })
                .duration(5000)
                .attrTween("transform", translateAlong(line7.node()))
                .each("end", transition);

            circle6.transition()
                .delay(function(d,i){
                    return  i * 300;
                })
                .duration(5000)
                .attrTween("transform", translateAlong(line6.node()))
                .each("end", transition);

            circle5.transition()
                .delay(function(d,i){
                    return  i * 200;
                })
                .duration(5000)
                .attrTween("transform", translateAlong(line5.node()))
                .each("end", transition);
        }

        // add the image/circle at San Francisco 
        svg.append("image")
            .attr("xlink:href","football.png")
            .attr("transform", function() {
                return "translate(" + projection([-123.9194155, 38.7749295]) + ")" ;})
            .attr("width",40)
            .attr("height",40);

        // svg.append("circle")
        //     .attr("r", 10)
        //     .style("fill", "black")
        //     .attr("transform", function() {
        //         return "translate(" + projection([-122.4194155, 37.7749295]) + ")";
        //     });



        // Returns an attrTween for translating along the specified path element.
        function translateAlong(path) {
            var l = path.getTotalLength();
            return function(d, i, a) {
                return function(t) {
                    var p = path.getPointAtLength((1-t) * l);
                    return "translate(" + p.x + "," + p.y + ")";
                };
            };
        }

    });

    function lngLatToArc(d, sourceName, targetName, bend) {
        bend = 1;
       
        var sourceLngLat = d[sourceName],
            targetLngLat = d[targetName];
        if (targetLngLat && sourceLngLat) {
            var sourceXY = projection(sourceLngLat),
                targetXY = projection(targetLngLat);
            var sourceX = sourceXY[0],
                sourceY = sourceXY[1];
            var targetX = targetXY[0],
                targetY = targetXY[1];
            var dx = targetX - sourceX,
                dy = targetY - sourceY,
                dr = Math.sqrt(dx * dx + dy * dy) * bend;
            // To avoid a whirlpool effect, make the bend direction consistent regardless of whether the source is east or west of the target
            var west_of_source = (targetX - sourceX) < 0;
            if (west_of_source) return "M" + targetX + "," + targetY + "A" + dr + "," + dr + " 0 0,1 " + sourceX + "," + sourceY;
            return "M" + sourceX + "," + sourceY + "A" + dr + "," + dr + " 0 0,1 " + targetX + "," + targetY;

        } else {
            return "M0,0,l0,0z";
        }
    }





    d3.select(self.frameElement).style("height", height + "px");

    function responsivefy(svg) {

        var container = d3.select(svg.node().parentNode),
            width = parseInt(svg.style("width")),
            height = parseInt(svg.style("height")),
            aspect = width / height;

        svg.attr("viewBox", "0 0 " + width + " " + height)
            .attr("perserveAspectRatio", "xMinYMid")
            .call(resize);

        d3.select(window).on("resize." + container.attr("#graphic"), resize);

        function resize() {
            var targetWidth = parseInt(container.style("width"));
            svg.attr("width", targetWidth);
            svg.attr("height", Math.round(targetWidth / aspect));
        }
    };


    </script>
